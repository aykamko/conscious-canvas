<head>
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
</head>

<body>
    <style>
        html,
        body {
            margin: 8px;
            /* Disable page scrolling */
            /*
            height: 100%;
            width: 100%;
            overflow: hidden;
            */
        }

        button {
            height: 60px;
            min-width: 160px;
        }

        .center-text {
            text-align: center;
        }

        .flex-center {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        * {
            -moz-user-select: none;
            -webkit-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        .prompt-container {
            margin: 32px 0;
            text-align: center;
        }

        #prompt-help-text {
            color: gray;
        }

        .prompt-help-text-container {
            margin-top: 16px;
        }

        .canvas-pad {
            background-color: white;
            border: 1px solid gray;
        }

        .canvas-controls {
            display: flex;
            flex-direction: column;

            height: 512px;
        }

        .right-controls {
            position: absolute;
            top: 8px;
            right: 32px;
        }

        .left-controls {
            position: absolute;
            top: 8px;
            left: 32px;
        }

        .canvas-controls>div {
            margin-top: 10px;
        }

        .creation-container {
            margin-top: 60px;
        }

        .create-progress-container {
            width: 512px;
            display: none;
        }

        #create-progress {
            width: 100%;
        }

        .creation-output {
            display: none;
        }

        #output {
            border: 1px solid gray;
        }

        .flex-bottom {
            flex: 1 0;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
        }

        #createArt {
            display: none;
        }
    </style>

    <div class="flex-center">
        <div>
            <canvas id="canvas-pad" class="canvas-pad" width="512" height="512"></canvas>
            <div id="prompt-container" class="prompt-container">
                <div><span id="prompt"></span></div>
                <div class="prompt-help-text-container">
                    <span id="prompt-help-text">Tap on the right to record a prompt ðŸ‘‰</span>
                </div>
            </div>
        </div>
    </div>

    <div class="canvas-controls right-controls">
        <div>
            <button id="undo">Undo</button>
        </div>
        <div class="flex-bottom">
            <div>
                <button id="recordPrompt">ðŸ”´ Record Prompt</button>
            </div>
        </div>
    </div>

    <div class="canvas-controls left-controls">
        <div>
            <button id="reset">Reset</button>
        </div>
        <div class="flex-bottom">
            <div>
                <button id="createArt">ðŸŒˆ Recreate</button>
            </div>
        </div>
    </div>

    <div class="creation-container flex-center">
        <div>
            <div class="create-progress-container">
                <div class="center-text">
                    Creating...
                </div>
                <progress id="create-progress" value="0" max="100"></progress>
            </div>

            <div class="creation-output">
                <img id="output" />
            </div>
        </div>
    </div>

    <!-- Source: https://github.com/szimek/signature_pad -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script> -->
    <script src="js/vendor/signature_pad.umd.min.js"></script>
    <!-- Source: https://github.com/muaz-khan/RecordRTC/tree/master -->
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/RecordRTC/5.6.2/RecordRTC.js"></script> -->
    <script src="js/vendor/RecordRTC.js"></script>
    <script src="js/lib.js"></script>
    <script>
        const actionEvent = isIOS() ? "touchstart" : "click";

        const creationOutputContainer = document.querySelector(".creation-output");
        const progressBarContainer = document.querySelector(".create-progress-container");
        const progressBar = document.getElementById("create-progress");

        const promptContainer = document.getElementById("prompt-container");
        const promptSpan = document.getElementById("prompt");
        const promptHelpTextSpan = document.getElementById("prompt-help-text");

        const canvas = document.querySelector("canvas");
        const signaturePad = new SignaturePad(canvas, {
            backgroundColor: "rgb(255, 255, 255)", // set background color to white
        });

        let currentPrompt = null;
        let recorder = null;

        const createButton = document.getElementById("createArt");

        async function generateArt() {
            if (signaturePad.isEmpty() || !currentPrompt) {
                return alert("Please provide a sketch and prompt first.");
            }

            createButton.disabled = true;
            showElement(progressBarContainer);
            updateProgressOverNSeconds(progressBar, AVG_SEC_TO_CREATE);

            const img_data = signaturePad.toDataURL("image/jpg");

            const requestPayload = {
                scribble_control_png_b64: img_data,
                prompt: currentPrompt,
            };

            const response = await fetch("/generate", {
                method: "POST",
                mode: "cors",
                cache: "no-cache",
                credentials: "same-origin",
                headers: { "Content-Type": "application/json" },
                referrerPolicy: "no-referrer",
                body: JSON.stringify(requestPayload),
            });
            const respData = await response.json();
            console.log(respData["message"]);

            hideElement(progressBarContainer);
            const outputImg = document.getElementById("output");
            if (outputImg) {
                outputImg.src = respData["img_b64"];
            }

            showElement(creationOutputContainer);
            createButton.textContent = "ðŸŒˆ Recreate";
            createButton.disabled = false;
        }
        createButton.addEventListener(actionEvent, generateArt);

        const resetButton = document.getElementById("reset");
        resetButton.addEventListener(actionEvent, function () {
            signaturePad.clear();

            hideElement(createButton)
            promptSpan.textContent = "";
            promptHelpTextSpan.textContent = "Tap on the right to record a prompt ðŸ‘‰";
            currentPrompt = null;

            hideElement(creationOutputContainer);
            hideElement(progressBarContainer);
        });

        const undoButton = document.getElementById("undo");
        undoButton.addEventListener(actionEvent, function () {
            var data = signaturePad.toData();
            if (data) {
                data.pop(); // remove the last dot or line
                signaturePad.fromData(data);
            }
        });

        const recordPromptButton = document.getElementById("recordPrompt");
        recordPromptButton.addEventListener(actionEvent, async () => {
            const recorderState = await recorder?.getState();
            if (recorderState != "recording") {
                recordPromptButton.disabled = true;
                promptSpan.textContent = "";

                promptHelpTextSpan.textContent = "Setting up microphone...";
                let stream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                    },
                });
                firstRecording = false;

                recorder = new RecordRTCPromisesHandler(stream, {
                    type: "audio",
                    recorderType: StereoAudioRecorder, // required to record .wav
                    mimeType: "audio/wav",
                });
                recorder.startRecording();

                promptHelpTextSpan.textContent = "Recording. Tap again to stop...";
                recordPromptButton.disabled = false;
                recordPromptButton.textContent = "â¸ Stop Recording";

            } else {
                if (!recorder) return;

                recordPromptButton.disabled = true;
                promptHelpTextSpan.textContent = "Processing your voice...";

                await recorder.stopRecording();
                let audioBlob = await recorder.getBlob();

                let formData = new FormData();
                formData.append("audio_file", audioBlob, "recording.wav");

                try {
                    const resp = await fetch("/transcribe", {
                        method: "POST",
                        body: formData,
                    });
                    const respData = await resp.json();
                    const transcription = respData["transcription"];

                    console.log(transcription);

                    currentPrompt = transcription;
                    promptSpan.textContent = transcription;

                    promptHelpTextSpan.textContent = "";
                    recordPromptButton.textContent = "ðŸ”´ Record Again";
                    showElement(createButton)

                    createButton.disabled = signaturePad.isEmpty() || !currentPrompt;
                    generateArt();
                } finally {
                    recordPromptButton.disabled = false;
                    try {
                        await recorder.destroy();
                    } catch (e) {
                        console.error("Failed to destroy RecordRTC", e);
                    }
                    recorder = null;
                }
            }
        });

        signaturePad.addEventListener("endStroke", () => {
            createButton.disabled = signaturePad.isEmpty() || !currentPrompt;
        });
    </script>
</body>