<style>
    /* Disable page scrolling */
    /*
    html,
    body {
        margin: 8px;
        height: 100%;
        width: 100%;
        overflow: hidden;
    }
    */

    button {
        height: 60px;
        min-width: 120px;
    }

    .flex-center {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .noselect {
        position: relative;
        -moz-user-select: none;
        -webkit-user-select: none;
        -ms-user-select: none;
        user-select: none;
    }

    .prompt {
        padding: 20px 0;
        text-align: center;
    }

    .canvas-pad {
        background-color: white;
        border: 1px solid gray;
    }

    .canvas-controls {
        position: absolute;
        top: 30px;
        right: 30px;
    }

    .canvas-controls>div {
        margin: 10px;
    }

    .creation-container {
        margin-top: 60px;
    }

    #output {
        border: 1px solid gray;
    }
</style>

<div class="flex-center">
    <div class="noselect">
        <canvas id="canvas-pad" class="canvas-pad" width="512" height="512"></canvas>
        <div id="prompt-container" class="prompt">
            <span id="prompt">Tap here to record a prompt.</span>
        </div>
    </div>
</div>

<div class="canvas-controls">
    <div>
        <button id="undo">Undo</button>
    </div>
    <div>
        <button id="clear">Clear</button>
    </div>
</div>

<div class="creation-container flex-center">
    <div class="noselect">
        <div>
            <button id="createArt" disabled>Create your Art</button>
        </div>

        <div>
            <label>Image output:</label>
            <div>
                <img id="output" />
            </div>
        </div>
    </div>
</div>

<!-- Source: https://github.com/szimek/signature_pad -->
<!-- <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script> -->
<script src="js/signature_pad.umd.min.js"></script>
<!-- Source: https://github.com/muaz-khan/RecordRTC/tree/master -->
<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/RecordRTC/5.6.2/RecordRTC.js"></script> -->
<script src="js/RecordRTC.js"></script>
<script>
    function isIOS() {
        if (/iPad|iPhone|iPod/.test(navigator.platform)) {
            return true;
        } else {
            return navigator.maxTouchPoints &&
                navigator.maxTouchPoints > 2 &&
                /MacIntel/.test(navigator.platform);
        }
    }

    const canvas = document.querySelector("canvas");
    const signaturePad = new SignaturePad(canvas, {
        backgroundColor: "rgb(255, 255, 255)", // set background color to white
    });

    let currentPrompt = null;
    let recorder = null;

    const createButton = document.getElementById("createArt");

    createButton.addEventListener("click", async function () {
        if (signaturePad.isEmpty() || !currentPrompt) {
            return alert("Please provide a sketch and prompt first.");
        }

        const img_data = signaturePad.toDataURL("image/jpg");

        const requestPayload = {
            scribble_control_png_b64: img_data,
            prompt: currentPrompt,
        };

        const response = await fetch("/generate", {
            method: "POST",
            mode: "cors",
            cache: "no-cache",
            credentials: "same-origin",
            headers: { "Content-Type": "application/json" },
            referrerPolicy: "no-referrer",
            body: JSON.stringify(requestPayload),
        });
        const respData = await response.json();
        console.log(respData["message"]);

        const outputImg = document.getElementById("output");
        if (outputImg) {
            outputImg.src = respData["img_b64"];
        }
    });

    const clearButton = document.getElementById("clear");
    clearButton.addEventListener("click", function () {
        signaturePad.clear();
    });

    const undoButton = document.getElementById("undo");
    undoButton.addEventListener("click", function () {
        var data = signaturePad.toData();
        if (data) {
            data.pop(); // remove the last dot or line
            signaturePad.fromData(data);
        }
    });

    const promptContainer = document.getElementById("prompt-container");
    const promptSpan = document.getElementById("prompt");
    let firstRecording = true;

    promptContainer.addEventListener(isIOS() ? "touchstart" : "click", async () => {
        const recorderState = await recorder?.getState();
        if (recorderState != "recording") {
            promptSpan.textContent = "Initializing...";
            let stream = await navigator.mediaDevices.getUserMedia({
                audio: {
                    echoCancellation: true,
                },
            });
            firstRecording = false;

            recorder = new RecordRTCPromisesHandler(stream, {
                type: "audio",
                recorderType: StereoAudioRecorder, // required to record .wav
                mimeType: "audio/wav",
            });
            recorder.startRecording();
            promptSpan.textContent = "Recording, tap to stop...";

        } else {
            if (!recorder) return;

            promptSpan.textContent = "Processing your voice...";

            await recorder.stopRecording();
            let audioBlob = await recorder.getBlob();

            let formData = new FormData();
            formData.append("audio_file", audioBlob, "recording.wav");

            try {
                const resp = await fetch("/transcribe", {
                    method: "POST",
                    body: formData,
                });
                const respData = await resp.json();
                const transcription = respData["transcription"];

                console.log(transcription);

                currentPrompt = transcription;
                promptSpan.textContent = transcription;

                createButton.disabled = signaturePad.isEmpty() || !currentPrompt;
            } finally {
                try {
                    await recorder.destroy();
                } catch (e) {
                    console.error("Failed to destroy RecordRTC", e);
                }
                recorder = null;
            }
        }
    });

    // const clearPromptButton = document.getElementById("clearPrompt");
    // clearPromptButton.addEventListener("click", () => {
    //     currentPrompt = null;
    //     document.getElementById("prompt").textContent = "";
    // });

    signaturePad.addEventListener("endStroke", () => {
        createButton.disabled = signaturePad.isEmpty() || !currentPrompt;
    });
</script>